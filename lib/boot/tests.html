var assert = require('chai').assert,
    estraparse = require('esprima-jquery-map'),
    sinon = require('sinon');

describe('problem', function() {
  before(function(){
    this.tree = estraparse(code);
  });

  it("Within your `for` loop, you need to add an `if` statement.", function() {
    assert(this.tree.find('forstatement ifstatement').length > 0);  
  });
  it("Within the `if` statement, you'll need to halve the number of sheep and log the message 'Removing <number> sheep from the population. Phew!' to the console.", function() {
    var logInFor = this.tree.find("forstatement ifstatement identifier[name='console']+identifier[name='log']").length > 0;
    assert(logInFor);
  });

  describe('with logging', function() {
    before(function() {
      sinon.spy(console, "log");
      eval(window.code);
    });
    after(function() {
      console.log.restore();
    });
    it("You are calling `console.log` too few times. This probably means the condition on your `if` statement is incorrect. Make sure it tests that `numSheep` is greater than 10000.", function() {
      if(console.log.callCount < 18) { assert(false); }
    });
    it("You are calling `console.log` too many times. This probably means the condition on your `if` statement is incorrect. Make sure it tests that `numSheep` is greater than 10000.", function() {
      if(console.log.callCount > 18) { assert(false); }
    });
    it("You're calling `console.log` the correct number of times, but not logging the correct messages. Are you diving the `numSheep` by 2 whenever there are more than 10000.", function() {
      var numSheep = 4,
          monthsToPrint = 12,
          logNumber = 0,
          logCall = '',
          message = '';

      for(var monthNumber = 1; monthNumber <= monthsToPrint; monthNumber++) {
        if(numSheep > 10000) {
          numSheep = numSheep/2;
          logCall = console.log.getCall(logNumber++);
          message = "Removing " + numSheep + " sheep from the population. Phew!";
          assert(logCall.args[0] == message);
        }
        numSheep*=4;
        logCall = console.log.getCall(logNumber++);
        message = "There will be " + numSheep + " sheep after " + monthNumber + " month(s)!"
        assert(logCall.args[0] == message);
      }
    });
  });
});